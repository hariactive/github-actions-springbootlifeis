name: Spring Boot CI/CD with Docker

on: 
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

env:
  DOCKER_IMAGE: springboot-lifeis

jobs:
  build-test-docker:
    name: ğŸ—ï¸ Build, Test & Dockerize
    runs-on: ubuntu-latest
    
    steps:
    # Step 1: Checkout code
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    # Step 2: Setup Java 21
    - name: â˜• Set up Java 21
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '21'
        
    # Step 3: Build and test
    - name: ğŸ”¨ Build and test
      run: |
        echo "Starting Maven build..."
        mvn clean compile
        echo "Running tests..."
        mvn test
        echo "Packaging JAR..."
        mvn package -DskipTests
        echo "âœ… Build completed successfully!"
        
    # Step 4: Build Docker image
    - name: ğŸ³ Build Docker image
      run: |
        echo "Building Docker image..."
        docker build -t $DOCKER_IMAGE .
        echo "Docker images:"
        docker images
        echo "âœ… Docker image built!"

    # Step 5: Test Docker image
    - name: ğŸ§ª Test Docker image
      run: |
        echo "Testing Docker image..."
        docker run --rm --entrypoint java $DOCKER_IMAGE -version
        docker run --rm --entrypoint ls $DOCKER_IMAGE -la /app/
        echo "ğŸ‰ Docker image works perfectly!"
        
    # Step 6: Upload artifacts
    - name: ğŸ“¤ Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: springboot-app
        path: |
          target/*.jar
          Dockerfile
        
    # Step 7: Success message
    - name: ğŸ‰ Pipeline Success
      run: |
        echo "=========================================="
        echo "ğŸš€ CI/CD PIPELINE COMPLETED SUCCESSFULLY!"
        echo "ğŸ“¦ JAR File: target/*.jar"
        echo "ğŸ³ Docker Image: $DOCKER_IMAGE"
        echo "â­ Ready for deployment!"
        echo "=========================================="
