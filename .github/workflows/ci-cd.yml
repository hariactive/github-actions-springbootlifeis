name: Spring Boot CI/CD with Docker

on: 
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

env:
  DOCKER_IMAGE: springboot-lifeis

jobs:
  build-test-docker:
    name: 🏗️ Build, Test & Dockerize
    runs-on: ubuntu-latest
    
    steps:
    # Step 1: Checkout code
    - name: 📥 Checkout code
      uses: actions/checkout@v4
      
    # Step 2: Setup Java 21
    - name: ☕ Set up Java 21
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '21'
        
    # Step 3: Build and test
    - name: 🔨 Build and test
      run: |
        echo "Starting Maven build..."
        mvn clean compile
        echo "Running tests..."
        mvn test
        echo "Packaging JAR..."
        mvn package -DskipTests
        echo "✅ Build completed successfully!"
        
    # Step 4: Build Docker image
    - name: 🐳 Build Docker image
      run: |
        echo "Building Docker image..."
        docker build -t $DOCKER_IMAGE .
        echo "Docker images:"
        docker images
        echo "✅ Docker image built!"

    # Step 5: Test Docker image
    - name: 🧪 Test Docker image
      run: |
        echo "Testing Docker image..."
        docker run --rm --entrypoint java $DOCKER_IMAGE -version
        docker run --rm --entrypoint ls $DOCKER_IMAGE -la /app/
        echo "🎉 Docker image works perfectly!"
        
    # Step 6: Upload artifacts
    - name: 📤 Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: springboot-app
        path: |
          target/*.jar
          Dockerfile
        
    # Step 7: Success message
    - name: 🎉 Pipeline Success
      run: |
        echo "=========================================="
        echo "🚀 CI/CD PIPELINE COMPLETED SUCCESSFULLY!"
        echo "📦 JAR File: target/*.jar"
        echo "🐳 Docker Image: $DOCKER_IMAGE"
        echo "⭐ Ready for deployment!"
        echo "=========================================="
