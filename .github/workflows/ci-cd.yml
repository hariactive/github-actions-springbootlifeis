name: Spring Boot CI/CD with Docker

on: 
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

env:
  DOCKER_IMAGE: springboot-lifeis
  DOCKERHUB_USERNAME: hari7706shukla@gmail.com    # ğŸ‘ˆ Change this to your Docker Hub username
  DOCKERHUB_PASSWORD: haridocker      # ğŸ‘ˆ Change this to your Docker Hub password (real one for your local use only)

jobs:
  build-test-docker:
    name: ğŸ—ï¸ Build, Test & Dockerize
    runs-on: ubuntu-latest
    
    steps:
    # Step 1: Checkout your code from GitHub
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    # Step 2: Setup Java 21 using Temurin distribution
    - name: â˜• Set up Java 21
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '21'
        
    # Step 3: Build and test your Spring Boot application
    - name: ğŸ”¨ Build and test
      run: |
        echo "Starting Maven build..."
        mvn clean compile
        echo "Running tests..."
        mvn test
        echo "Packaging JAR..."
        mvn package -DskipTests
        echo "âœ… Build completed successfully!"
        
    # Step 4: Build Docker image from Dockerfile
    - name: ğŸ³ Build Docker image
      run: |
        echo "Building Docker image..."
        docker build -t $DOCKER_IMAGE .
        echo "Docker images:"
        docker images
        echo "âœ… Docker image built successfully!"

    # Step 5: Log in to Docker Hub (âš ï¸ Uses password directly)
    - name: ğŸ” Docker Hub Login
      run: |
        echo "$DOCKERHUB_PASSWORD" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
        echo "âœ… Logged in to Docker Hub successfully!"

    # Step 6: Push Docker image to Docker Hub
    - name: ğŸš€ Push Docker Image
      run: |
        docker tag $DOCKER_IMAGE $DOCKERHUB_USERNAME/$DOCKER_IMAGE:latest
        docker push $DOCKERHUB_USERNAME/$DOCKER_IMAGE:latest
        echo "âœ… Docker image pushed to Docker Hub successfully!"
        
    # Step 7: Upload build artifacts (optional)
    - name: ğŸ“¤ Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: springboot-app
        path: |
          target/*.jar
          Dockerfile
        
    # Step 8: Final success message
    - name: ğŸ‰ Pipeline Success
      run: |
        echo "=========================================="
        echo "ğŸš€ CI/CD PIPELINE COMPLETED SUCCESSFULLY!"
        echo "ğŸ“¦ JAR File: target/*.jar"
        echo "ğŸ³ Docker Image: $DOCKERHUB_USERNAME/$DOCKER_IMAGE:latest"
        echo "â­ Ready for deployment on Docker Hub!"
        echo "=========================================="
